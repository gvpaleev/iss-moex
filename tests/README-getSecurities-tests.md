# Тесты getSecurities для всех комбинаций Engine/Market

## Описание

Тесты для метода `getSecurities` библиотеки MOEX API разделены на два файла:
- `getSecurities-all-combinations-mock.test.ts` - mock тесты без обращения к реальному API
- `getSecurities-all-combinations-real.test.ts` - тесты с реальным API MOEX

Тесты проверяют все возможные комбинации торговых систем (Engine) и рынков (Market).

## Статистика покрытия

- **Всего Engine**: 6
  - stock (Фондовый рынок)
  - state (Рынок государственных ценных бумаг)
  - currency (Валютный рынок)
  - futures (Срочный рынок)
  - commodity (Товарный рынок)
  - interventions (Товарные интервенции)

- **Всего Market**: 13
  - shares (Рынок акций)
  - bonds (Рынок облигаций)
  - ndm (Режим переговорных сделок)
  - otc (Внебиржевой рынок)
  - ccp (Центральный контрагент)
  - deposit (Депозитный рынок)
  - repo (Рынок сделок РЕПО)
  - qnv (Квалифицированный режим торгов)
  - mamc (Рынок M&A и прямых инвестиций)
  - foreignexchange (Валютный рынок)
  - selt (Система электронных лотовых торгов)
  - psdb (Рынок госзакупок)
  - mixed (Смешанный режим торгов)

- **Всего комбинаций**: 78 (6 × 13)

## Типы тестов

### 1. Mock тесты (по умолчанию)
Запускаются без обращения к реальному API. Проверяют:
- Правильность формирования URL для каждой комбинации Engine/Market
- Корректную обработку успешных ответов
- Обработку пустых ответов
- Обработку HTTP ошибок (404, 500 и т.д.)
- Обработку сетевых ошибок
- Обработку некорректного JSON
- Использование параметра limit

### 2. Тесты с реальным API
Запускаются с флагом `USE_REAL_API=true`. Проверяют:
- Реальную доступность комбинаций Engine/Market
- Структуру возвращаемых данных
- Обработку ошибок от реального API

## Запуск тестов

### Запуск mock тестов:
```bash
npm test -- tests/getSecurities-all-combinations-mock.test.ts
```

### Запуск тестов с реальным API:
```bash
npm test -- tests/getSecurities-all-combinations-real.test.ts
```

### Запуск всех тестов getSecurities:
```bash
npm test -- tests/getSecurities-all-combinations
```

## Особенности реализации

1. **Rate Limiting**: Для тестов с реальным API реализован простой rate limiter, который:
   - Ограничивает количество одновременных запросов (1 запрос)
   - Добавляет задержку между запросами (200мс)
   - Предотвращает блокировку со стороны API MOEX

2. **Timeout**: Для тестов с реальным API установлен увеличенный timeout (30 секунд)

3. **Обработка ошибок**: Тесты корректно обрабатывают ситуации, когда определенные комбинации Engine/Market не поддерживаются API

## Результаты тестирования

### Mock тесты (`getSecurities-all-combinations-mock.test.ts`)
При запуске все 250 тестов должны проходить успешно:
- 234 теста для комбинаций (78 комбинаций × 3 теста на каждую)
- 5 тестов для разных значений limit
- 3 теста для обработки ошибок
- 7 тестов для различных HTTP кодов ошибок
- 2 теста для проверки URL конструкции
- 1 summary тест

### Тесты с реальным API (`getSecurities-all-combinations-real.test.ts`)
- 78 тестов для всех комбинаций Engine/Market
- 3 теста для известных валидных комбинаций с детальной проверкой
- 4 теста для проверки параметра limit
- 1 тест производительности для параллельных запросов
- 1 summary тест с отчетом о валидных/невалидных комбинациях

## Примечания

- Не все комбинации Engine/Market являются валидными на MOEX
- Некоторые комбинации могут возвращать пустые результаты даже если они технически поддерживаются
- При тестировании с реальным API некоторые тесты могут завершаться с ошибками HTTP 404, что является ожидаемым поведением для неподдерживаемых комбинаций
- Тесты с реальным API выводят детальную информацию о найденных ценных бумагах и итоговую статистику валидных/невалидных комбинаций

## Структура файлов

```
tests/
├── getSecurities-all-combinations-mock.test.ts    # Mock тесты
├── getSecurities-all-combinations-real.test.ts    # Тесты с реальным API
└── README-getSecurities-tests.md                  # Эта документация
```
